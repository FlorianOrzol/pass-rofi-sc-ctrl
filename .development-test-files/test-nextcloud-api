#!/bin/python3

import requests
import json
import os
import subprocess

# Die URL Ihrer Nextcloud-Instanz
NEXTCLOUD_URL = "https://cloud.orzol.link"

# Ihr Nextcloud-Benutzername und Passwort
USERNAME = "florian"
PASSWORD = "ich-hatte-Kasimir2"

# Der Pfad zu Ihrem Pass-Verzeichnis
PASS_DIR = "/home/username/.password-store"

# Die API-Endpunkt-URL
API_URL = f"{NEXTCLOUD_URL}/apps/passwords/api/1.0/list"

# Authentifizierung
auth = (USERNAME, PASSWORD)

def one_data():
    # Die Daten, die Sie importieren möchten
    data = {
        "label": "1 My Password",
        "password": "my-password",
    }
    
    # Senden Sie die Daten an die API
    response = requests.get(API_URL, auth=auth, data=json.dumps(data))
    
    # Überprüfen Sie, ob der Import erfolgreich war
    if response.status_code == 201:
        print("Password imported successfully")
    else:
        print("Failed to import password")
    print(response.status_code, response.text)


one_data() # Einzelnes Passwort importieren 

def import_passwords():
    # Durchlaufen Sie alle Passwörter in Ihrem Pass-Verzeichnis
    for root, dirs, files in os.walk(PASS_DIR):
        for file in files:
            if file.endswith(".gpg"):
                # Der Pfad zur Passwortdatei
                pass_file = os.path.join(root, file)
                
                # Der Name des Passworts
                pass_name = os.path.splitext(pass_file.replace(PASS_DIR + "/", ""))[0]
                
                # Das Passwort auslesen
                pass_password = subprocess.check_output(["pass", pass_name]).decode().strip()
                
                # Das Passwort in Nextcloud importieren
                data = {
                    "label": pass_name,
                    "password": pass_password,
                }
                response = requests.post(API_URL, auth=auth, data=json.dumps(data))
                
                # Überprüfen Sie, ob der Import erfolgreich war
                if response.status_code != 201:
                    print(f"Failed to import password: {pass_name}")
